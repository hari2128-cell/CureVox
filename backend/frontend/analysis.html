<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CureVox Analysis - Medical AI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-g: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass: rgba(255,255,255,0.1); --glass-border: rgba(255,255,255,0.2);
            --success: #10b981; --warning: #f59e0b; --purple: #8b5cf6;
            --danger: #ef4444; --shadow-2xl: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #f0f2f5 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        
        .glass { 
            background: var(--glass); backdrop-filter: blur(25px); 
            border: 1px solid var(--glass-border); box-shadow: var(--shadow-2xl);
        }
        
        /* Header */
        .header { 
            position: sticky; top: 0; z-index: 100; background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px); box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        .nav { 
            max-width: 1400px; margin: 0 auto; padding: 1.5rem 3rem; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .logo { 
            font-size: 1.8rem; font-weight: 800; background: var(--primary-g);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .back-btn, .next-btn {
            padding: 0.75rem 2rem; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;
            backdrop-filter: blur(10px); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .back-btn:hover, .next-btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
        .next-btn { background: var(--success); }
        .next-btn:hover { background: #059669; }
        
        /* Main */
        .main { max-width: 1000px; margin: 4rem auto; padding: 0 3rem; }
        
        /* Progress Bar */
        .progress-container {
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            border-radius: 50px; padding: 0.5rem; margin-bottom: 4rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .progress-bar {
            height: 8px; background: linear-gradient(90deg, var(--success), var(--warning), var(--purple));
            border-radius: 50px; transition: width 0.5s ease; width: 33%;
        }
        .progress-steps {
            display: flex; justify-content: space-between; margin-top: 1rem;
            font-weight: 600; color: #64748b;
        }
        .progress-steps .active { color: var(--success); }
        
        /* Analysis Panel */
        .analysis-panel {
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            border-radius: 32px; padding: 4rem; text-align: center; box-shadow: var(--shadow-2xl);
            position: relative; overflow: hidden;
        }
        .analysis-panel::before {
            content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(102,126,234,0.1) 0%, transparent 70%);
        }
        .analysis-title {
            font-size: 3rem; font-weight: 800; background: var(--primary-g);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 1rem; position: relative; z-index: 1;
        }
        .analysis-subtitle {
            font-size: 1.3rem; color: #64748b; margin-bottom: 3rem; position: relative; z-index: 1;
        }
        
        /* Recording Interface */
        .recording-interface {
            display: none; min-height: 400px; align-items: center; justify-content: center;
        }
        .recording-interface.active { display: flex; flex-direction: column; gap: 3rem; }
        
        .wave-visualizer {
            height: 120px; display: flex; align-items: flex-end; gap: 2px; padding: 2rem;
            background: linear-gradient(180deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
            border-radius: 24px; backdrop-filter: blur(20px); margin-bottom: 2rem;
        }
        .wave-bar {
            flex: 1; background: linear-gradient(180deg, var(--success), #059669);
            border-radius: 12px 12px 0 0; transition: height 0.1s ease;
            max-height: 100px; height: 20px; position: relative; overflow: hidden;
        }
        .wave-bar::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
        
        .record-btn {
            width: 140px; height: 140px; border-radius: 50%; border: none;
            font-size: 3rem; color: white; cursor: pointer; transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
            backdrop-filter: blur(20px); position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .record-btn.recording {
            background: linear-gradient(135deg, var(--danger), #dc2626); animation: pulse 1.2s infinite;
            box-shadow: 0 0 0 0 rgba(239,68,68,0.7); 
        }
        .record-btn.recording:hover { box-shadow: 0 0 0 20px rgba(239,68,68,0); }
        .record-btn:not(.recording) {
            background: rgba(255,255,255,0.2); border: 4px solid rgba(255,255,255,0.3);
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239,68,68,0); }
            100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
        }
        
        /* Image Upload */
        .image-upload {
            border: 3px dashed rgba(102,126,234,0.4); border-radius: 24px;
            padding: 4rem 2rem; cursor: pointer; transition: all 0.3s;
            background: rgba(255,255,255,0.6); backdrop-filter: blur(20px);
        }
        .image-upload:hover, .image-upload.dragover {
            border-color: var(--primary-g); background: rgba(102,126,234,0.1);
            transform: translateY(-4px); box-shadow: var(--shadow-2xl);
        }
        .image-upload-icon { font-size: 5rem; color: #93c5fd; margin-bottom: 2rem; }
        .image-preview {
            max-width: 300px; max-height: 300px; border-radius: 20px;
            box-shadow: var(--shadow-2xl); display: none;
        }
        
        .status-indicator {
            padding: 1rem 2rem; border-radius: 50px; font-weight: 700; font-size: 1.1rem;
            margin: 2rem 0; display: inline-flex; align-items: center; gap: 1rem;
        }
        .status-analyzing { background: linear-gradient(90deg, var(--warning), #eab308); color: white; }
        .status-complete { background: linear-gradient(90deg, var(--success), #059669); color: white; }
        
        @media (max-width: 768px) {
            .main { padding: 0 1.5rem; margin: 2rem auto; }
            .analysis-panel { padding: 2.5rem 2rem; }
            .analysis-title { font-size: 2.2rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <a href="dashboard.html" class="logo">
                <i class="fas fa-heartbeat"></i> CureVox Analysis
            </a>
            <div>
                <a href="dashboard.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
                <a href="chat.html" class="next-btn" id="nextBtn" onclick="completeAnalysis()">
                    <i class="fas fa-comments"></i> AI Consultation
                </a>
            </div>
        </nav>
    </header>

    <main class="main">
        <!-- Progress -->
        <div class="progress-container glass">
            <div class="progress-bar" id="progressBar"></div>
            <div class="progress-steps">
                <span class="active">1. Recording</span>
                <span>2. AI Chat</span>
                <span>3. Reports</span>
            </div>
        </div>

        <!-- Analysis Panel -->
        <section class="analysis-panel glass">
            <h1 class="analysis-title" id="analysisTitle">Breath Analysis</h1>
            <p class="analysis-subtitle" id="analysisSubtitle">
                Record your breathing patterns for comprehensive respiratory health assessment
            </p>

            <!-- Recording Interface (Breath/Cough) -->
            <div class="recording-interface active" id="recordingInterface">
                <div class="wave-visualizer" id="waveVisualizer">
                    <div class="wave-bar" style="animation-delay: 0s;"></div>
                    <div class="wave-bar" style="animation-delay: 0.1s;"></div>
                    <div class="wave-bar" style="animation-delay: 0.2s;"></div>
                    <div class="wave-bar" style="animation-delay: 0.3s;"></div>
                    <div class="wave-bar" style="animation-delay: 0.4s;"></div>
                    <div class="wave-bar" style="animation-delay: 0.5s;"></div>
                </div>
                
                <div style="display: flex; flex-direction: column; align-items: center; gap: 2rem;">
                    <div id="timer" style="font-size: 2.5rem; font-weight: 800; color: var(--success);">00:00</div>
                    <button class="record-btn" id="recordBtn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <div style="font-size: 1.2rem; color: #64748b; max-width: 400px;">
                        <div id="recordInstruction">Click to start recording your breathing</div>
                        <div id="recordStatus" style="display: none;">Recording... Speak naturally</div>
                    </div>
                </div>
            </div>

            <!-- Image Upload (Rash only) -->
            <div class="image-upload" id="imageUpload" style="display: none;">
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
                <i class="fas fa-image image-upload-icon"></i>
                <p style="font-size: 1.3rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">
                    Upload skin image for analysis
                </p>
                <p style="color: #6b7280; font-size: 1.1rem;">JPG, PNG â€¢ Max 10MB</p>
                <img class="image-preview" id="imagePreview" alt="Preview">
            </div>

            <!-- Status -->
            <div id="statusIndicator" class="status-indicator" style="display: none;"></div>
        </section>
    </main>

    <script>
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let timer = 0;
        let timerInterval = null;
        const analysisType = localStorage.getItem('analysisType') || 'breath';

        // Initialize
        document.addEventListener('DOMContentLoaded', initAnalysis);

        function initAnalysis() {
            // Check login
            const user = JSON.parse(localStorage.getItem('curevox_user'));
            if (!user) window.location.href = 'login.html';

            // Set analysis type
            setupAnalysisType();
            
            // Event listeners
            setupEventListeners();
        }

        function setupAnalysisType() {
            const titles = {
                breath: { title: 'ðŸ« Breath Analysis', subtitle: 'Record your breathing patterns for respiratory health insights' },
                cough: { title: 'ðŸ¤§ Cough Analysis', subtitle: 'Record cough patterns for detailed respiratory assessment' },
                rash: { title: 'ðŸ©¹ Rash Analysis', subtitle: 'Upload skin images for dermatological computer vision analysis' }
            };

            document.getElementById('analysisTitle').textContent = titles[analysisType].title;
            document.getElementById('analysisSubtitle').textContent = titles[analysisType].subtitle;

            if (analysisType === 'rash') {
                document.getElementById('recordingInterface').style.display = 'none';
                document.getElementById('imageUpload').style.display = 'block';
            }
        }

        function setupEventListeners() {
            // Recording
            document.getElementById('recordBtn').onclick = toggleRecording;
            
            // Image upload
            const imageUpload = document.getElementById('imageUpload');
            const imageInput = document.getElementById('imageInput');
            
            imageUpload.onclick = () => imageInput.click();
            imageInput.onchange = handleImageUpload;

            // Drag & drop for images
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
                imageUpload.addEventListener(event, preventDefaults);
            });
            imageUpload.addEventListener('drop', handleImageDrop);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        async function toggleRecording() {
            const btn = document.getElementById('recordBtn');
            
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = handleRecordingComplete;
                    
                    mediaRecorder.start();
                    startTimer();
                    isRecording = true;
                    
                    btn.classList.add('recording');
                    btn.innerHTML = '<i class="fas fa-stop"></i>';
                    document.getElementById('recordInstruction').style.display = 'none';
                    document.getElementById('recordStatus').style.display = 'block';
                } catch (err) {
                    alert('Microphone access required');
                }
            } else {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                stopTimer();
                isRecording = false;
                
                btn.classList.remove('recording');
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
                document.getElementById('recordInstruction').style.display = 'block';
                document.getElementById('recordStatus').style.display = 'none';
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timer++;
                const minutes = Math.floor(timer / 60).toString().padStart(2, '0');
                const seconds = (timer % 60).toString().padStart(2, '0');
                document.getElementById('timer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timer = 0;
            document.getElementById('timer').textContent = '00:00';
        }

        function handleRecordingComplete() {
            showStatus('Analysis complete! Moving to AI consultation...', 'complete');
            setTimeout(() => {
                window.location.href = 'chat.html';
            }, 2000);
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = e => {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    document.querySelector('.image-upload-icon').style.display = 'none';
                    
                    showStatus('Image analysis complete! Moving to AI consultation...', 'complete');
                    setTimeout(() => {
                        window.location.href = 'chat.html';
                    }, 2000);
                };
                reader.readAsDataURL(file);
            }
        }

        function handleImageDrop(e) {
            preventDefaults(e);
            const file = e.dataTransfer.files[0];
            document.getElementById('imageInput').files = e.dataTransfer.files;
            handleImageUpload({ target: { files: [file] } });
        }

        function showStatus(message, type) {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            indicator.className = `status-indicator status-${type}`;
            indicator.style.display = 'inline-flex';
        }

        function completeAnalysis() {
            if (analysisType === 'rash') {
                const imageInput = document.getElementById('imageInput');
                if (!imageInput.files[0]) {
                    alert('Please upload an image first');
                    return;
                }
            } else if (audioChunks.length === 0) {
                alert('Please record audio first');
                return;
            }
            window.location.href = 'chat.html';
        }
    </script>
</body>
</html>
